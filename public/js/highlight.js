!function(l){"use strict";function g(t){return!isNaN(parseFloat(t))&&isFinite(t)}var n=function(t,i){this.settings=l.extend({},n.DEFAULTS),this.scrollbarWidth=o.getScrollbarWidth(),this.isInput="input"==t[0].tagName.toLowerCase(),this.active=!1,this.matches=[],this.$el=t,this.$el.wrap('<div class="highlightTextarea"></div>'),this.$main=this.$el.parent(),this.$main.prepend('<div class="highlightTextarea-container"><div class="highlightTextarea-highlighter"></div></div>'),this.$container=this.$main.children().first(),this.$highlighter=this.$container.children(),this.setOptions(i),this.settings.id&&(this.$main[0].id=this.settings.id),this.settings.resizable&&this.applyResizable(),this.updateCss(),this.bindEvents(),this.highlight()};n.DEFAULTS={words:{},ranges:{},color:"#ffff00",caseSensitive:!0,wordsOnly:!1,resizable:!1,resizableOptions:{},id:"",debug:!1},n.prototype.highlight=function(){var r=this.$el.val(),h=this;h.spacer="",this.settings.wordsOnly&&(h.spacer="\\b");var a=[];if(l.each(this.settings.words,function(e,t){var i=new RegExp(h.spacer+"("+t.join("|")+")"+h.spacer,h.regParam),s=r.match(i);if(s){var n=[];l.each(s,function(t,i){a.push(i),-1===n.indexOf(i)&&(r=r.replace(new RegExp(i,"g"),'<mark style="background-color:'+e+';">$&</mark>',"g"),n.push(i))})}}),l.each(this.settings.ranges,function(t,i){if(i.start<r.length){r=o.strInsert(r,i.end,"</mark>");var e='<mark style="background-color:'+i.color+';"';null!=i.class&&(e+='class="'+i.class+'"'),e+=">",r=o.strInsert(r,i.start,e)}}),a.length!==this.matches.length){this.matches=a;var t=l.Event("matchesChanged");t.matches=this.matches,this.$el.trigger(t)}this.$highlighter.html(r),this.updateSizePosition()},n.prototype.setWords=function(t){this.setOptions({words:t,ranges:{}})},n.prototype.setRanges=function(t){this.setOptions({words:{},ranges:t})},n.prototype.enable=function(){this.bindEvents(),this.highlight()},n.prototype.disable=function(){this.unbindEvents(),this.$highlighter.empty()},n.prototype.destroy=function(){this.disable(),o.cloneCss(this.$container,this.$el,["background-image","background-color","background-position","background-repeat","background-origin","background-clip","background-size","background-attachment"]),this.$main.replaceWith(this.$el),this.$el.removeData("highlighter")},n.prototype.setOptions=function(t){"object"!=typeof t||l.isEmptyObject(t)||(l.extend(this.settings,t),this.regParam=this.settings.caseSensitive?"gm":"gim",l.isEmptyObject(this.settings.words)?l.isEmptyObject(this.settings.ranges)||(this.settings.words={},this.settings.ranges=o.cleanRanges(this.settings.ranges,this.settings.color)):(this.settings.words=o.cleanWords(this.settings.words,this.settings.color),this.settings.ranges={}),this.settings.debug?this.$main.addClass("debug"):this.$main.removeClass("debug"),this.active&&this.highlight())},n.prototype.bindEvents=function(){if(!this.active){this.active=!0;var t=this;this.$highlighter.bind({"this.highlighter":function(){t.$el.focus()}}),this.$el.bind({"input.highlightTextarea":o.throttle(function(){this.highlight()},100,this),"resize.highlightTextarea":o.throttle(function(){this.updateSizePosition(!0)},50,this),"scroll.highlightTextarea select.highlightTextarea":o.throttle(function(){this.updateSizePosition()},50,this)}),this.isInput&&this.$el.bind({"keydown.highlightTextarea keypress.highlightTextarea keyup.highlightTextarea":function(){setTimeout(l.proxy(t.updateSizePosition,t),1)},"blur.highlightTextarea":function(){this.value=this.value,this.scrollLeft=0,t.updateSizePosition.call(t)}})}},n.prototype.unbindEvents=function(){this.active&&(this.active=!1,this.$highlighter.off(".highlightTextarea"),this.$el.off(".highlightTextarea"))},n.prototype.updateCss=function(){o.cloneCss(this.$el,this.$main,["float","vertical-align"]),this.$main.css({width:this.$el.outerWidth(!0),height:this.$el.outerHeight(!0)}),o.cloneCss(this.$el,this.$container,["background-image","background-color","background-position","background-repeat","background-origin","background-clip","background-size","background-attachment","padding-top","padding-right","padding-bottom","padding-left"]),this.$container.css({top:o.toPx(this.$el.css("margin-top"))+o.toPx(this.$el.css("border-top-width")),left:o.toPx(this.$el.css("margin-left"))+o.toPx(this.$el.css("border-left-width")),width:this.$el.width(),height:this.$el.height()}),o.cloneCss(this.$el,this.$highlighter,["font-size","font-family","font-style","font-weight","font-variant","font-stretch","vertical-align","word-spacing","text-align","letter-spacing","text-rendering"]),this.$el.css({background:"none"})},n.prototype.applyResizable=function(){if(jQuery.ui){var t={handles:"se",resize:o.throttle(function(){this.updateSizePosition(!0)},50,this)},i=l.extend({},t,this.settings.resizableOptions);this.$el.resizable(i)}},n.prototype.updateSizePosition=function(t){t&&(this.$main.css({width:this.$el.outerWidth(!0),height:this.$el.outerHeight(!0)}),this.$container.css({width:this.$el.width(),height:this.$el.height()}));var i,e=0;i=this.isInput?99999:(("scroll"==this.$el.css("overflow")||"scroll"==this.$el.css("overflow-y")||"hidden"!=this.$el.css("overflow")&&"hidden"!=this.$el.css("overflow-y")&&this.$el[0].clientHeight<this.$el[0].scrollHeight)&&(e=this.scrollbarWidth),this.$el.width()-e),this.$highlighter.css({width:i,height:this.$el.height()+this.$el.scrollTop(),top:-this.$el.scrollTop(),left:-this.$el.scrollLeft()})};var o=function(){};o.getScrollbarWidth=function(){var t=l('<div style="width:50px;height:50px;overflow:auto"><div>&nbsp;</div></div>').appendTo("body"),i=t.children(),e=i.innerWidth()-i.height(100).innerWidth();return t.remove(),e},o.cloneCss=function(t,i,e){for(var s=0,n=e.length;s<n;s++)i.css(e[s],t.css(e[s]))},o.toPx=function(t){if(t==t.replace("em",""))return t!=t.replace("px","")?parseInt(t.replace("px","")):parseInt(t);var i=l('<div style="font-size:1em;margin:0;padding:0;height:auto;line-height:1;border:0;">&nbsp;</div>').appendTo("body");return t=Math.round(parseFloat(t.replace("em",""))*i.height()),i.remove(),t},o.htmlEntities=function(t){return t?l("<div></div>").text(t).html():""},o.strInsert=function(t,i,e){return t.slice(0,i)+e+t.slice(i)},o.throttle=function(n,r,h){var a={pid:null,last:0};return function(){function t(){return a.last=(new Date).getTime(),h?n.apply(h,Array.prototype.slice.call(e)):n.apply(s,Array.prototype.slice.call(e))}var i=(new Date).getTime()-a.last,e=arguments,s=this;return r<i?t():(clearTimeout(a.pid),void(a.pid=setTimeout(t,r-i)))}},o.cleanWords=function(t,i){var e={};l.isArray(t)||(t=[t]);for(var s=0,n=t.length;s<n;s++){var r=t[s];if(l.isPlainObject(r)){e[r.color]||(e[r.color]=[]),l.isArray(r.words)||(r.words=[r.words]);for(var h=0,a=r.words.length;h<a;h++)e[r.color].push(o.htmlEntities(r.words[h]))}else e[i]||(e[i]=[]),e[i].push(o.htmlEntities(r))}return e},o.cleanRanges=function(t,i){var e=[];(l.isPlainObject(t)||g(t[0]))&&(t=[t]);for(var s=0,n=t.length;s<n;s++){var r=t[s];if(l.isArray(r))e.push({color:i,start:r[0],end:r[1]});else if(r.ranges){(l.isPlainObject(r.ranges)||g(r.ranges[0]))&&(r.ranges=[r.ranges]);for(var h=0,a=r.ranges.length;h<a;h++)l.isArray(r.ranges[h])?e.push({color:r.color,class:r.class,start:r.ranges[h][0],end:r.ranges[h][1]}):(r.ranges[h].length&&(r.ranges[h].end=r.ranges[h].start+r.ranges[h].length),e.push(r.ranges[h]))}else r.length&&(r.end=r.start+r.length),e.push(r)}e.sort(function(t,i){return t.start==i.start?t.end-i.end:t.start-i.start});var o=-1;return l.each(e,function(t,i){i.start>=i.end&&l.error("Invalid range end/start"),i.start<o&&l.error("Ranges overlap"),o=i.end}),e.reverse(),e},l.fn.highlightTextarea=function(e){var s=arguments;return this.each(function(){var t=l(this),i=t.data("highlighter");!i&&"destroy"==e||(i||(i=new n(t,"object"==typeof e&&e),t.data("highlighter",i)),"string"==typeof e&&i[e].apply(i,Array.prototype.slice.call(s,1)))})}}(window.jQuery||window.Zepto);